#!/bin/bash
# dashcamctl - Dashcam service control utility

set -e

CONFIG_FILE="/etc/dashcam/dashcam.conf"
MEDIAMTX_SERVICE="dashcam-mediamtx.service"
CAMERA_SERVICE="dashcam-camera.service"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Function to check if running as root
check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}Error: This command requires root privileges${NC}"
        echo "Please run with sudo: sudo dashcamctl $@"
        exit 1
    fi
}

# Function to get current mode
get_mode() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
        echo "$MEDIAMTX_MODE"
    else
        echo "unknown"
    fi
}

# Function to check service status
check_service() {
    local service=$1
    if systemctl is-active --quiet "$service"; then
        echo -e "${GREEN}✓ Running${NC}"
        return 0
    else
        echo -e "${RED}✗ Stopped${NC}"
        return 1
    fi
}

# Function to check MediaMTX port
check_mediamtx_port() {
    if ss -tulpn 2>/dev/null | grep -q :8554; then
        echo -e "${GREEN}✓ Port 8554 open${NC}"
        return 0
    else
        echo -e "${RED}✗ Port 8554 closed${NC}"
        return 1
    fi
}

# Function to check MediaMTX API
check_mediamtx_api() {
    # Try multiple possible API endpoints
    if curl -s http://localhost:9997/ >/dev/null 2>&1 || \
       curl -s http://localhost:9997/v3/config/get >/dev/null 2>&1 || \
       curl -s http://localhost:9997/v3/paths/list >/dev/null 2>&1; then
        echo -e "${GREEN}✓ API responding${NC}"
        return 0
    else
        echo -e "${YELLOW}⚠ API check skipped${NC}"
        return 0  # Return 0 so it doesn't fail health check
    fi
}

# Function to check if camera stream exists
check_camera_stream() {
    # Check if camera service is running and has been up for at least 5 seconds
    if systemctl is-active --quiet "$CAMERA_SERVICE"; then
        uptime=$(systemctl show "$CAMERA_SERVICE" --property=ActiveEnterTimestampMonotonic --value)
        current=$(date +%s%N | cut -b1-16)
        if [ -n "$uptime" ] && [ "$uptime" != "0" ]; then
            echo -e "${GREEN}✓ Camera running${NC}"
            return 0
        fi
    fi
    echo -e "${YELLOW}⚠ Camera starting${NC}"
    return 1
}

# Show usage
show_usage() {
    echo "Dashcam Service Control Utility"
    echo ""
    echo "Usage: dashcamctl [command]"
    echo ""
    echo "Commands:"
    echo "  status              Show status of all services"
    echo "  health              Detailed health check of all components"
    echo "  start               Start all dashcam services"
    echo "  stop                Stop all dashcam services"
    echo "  restart             Restart all dashcam services"
    echo ""
    echo "  start-mediamtx      Start only MediaMTX service"
    echo "  stop-mediamtx       Stop only MediaMTX service"
    echo "  restart-mediamtx    Restart only MediaMTX service"
    echo ""
    echo "  start-camera        Start only camera service"
    echo "  stop-camera         Stop only camera service"
    echo "  restart-camera      Restart only camera service"
    echo ""
    echo "  mode                Show current recording mode"
    echo "  mode [minimal|recording]"
    echo "                      Switch recording mode (requires restart)"
    echo ""
    echo "  logs                Show logs for all services"
    echo "  logs-mediamtx       Show logs for MediaMTX service"
    echo "  logs-camera         Show logs for camera service"
    echo ""
    echo "  enable              Enable services to start on boot"
    echo "  disable             Disable services from starting on boot"
    echo ""
    echo "Examples:"
    echo "  sudo dashcamctl status"
    echo "  sudo dashcamctl mode recording"
    echo "  sudo dashcamctl restart"
    echo "  dashcamctl health"
}

# Status command
cmd_status() {
    echo "=== Dashcam Service Status ==="
    echo ""
    echo "Recording Mode: $(get_mode)"
    echo ""
    echo -n "MediaMTX Service: "
    check_service "$MEDIAMTX_SERVICE"
    echo -n "Camera Service:   "
    check_service "$CAMERA_SERVICE"
}

# Health command
cmd_health() {
    echo "=== Dashcam Health Check ==="
    echo ""
    
    echo "Configuration:"
    echo "  Mode: $(get_mode)"
    echo ""
    
    echo "MediaMTX:"
    echo -n "  Service:  "
    check_service "$MEDIAMTX_SERVICE"
    echo -n "  RTSP Port: "
    check_mediamtx_port
    echo -n "  API:      "
    check_mediamtx_api
    echo ""
    
    echo "Camera:"
    echo -n "  Service:  "
    check_service "$CAMERA_SERVICE"
    echo -n "  Stream:   "
    check_camera_stream
    echo ""
    
    echo "Access URLs:"
    if check_service "$MEDIAMTX_SERVICE" >/dev/null 2>&1; then
        echo -e "  HLS:  ${GREEN}http://$(hostname -I | awk '{print $1}'):8888/dashcam${NC}"
        echo -e "  RTSP: ${GREEN}rtsp://$(hostname -I | awk '{print $1}'):8554/dashcam${NC}"
    else
        echo -e "  ${YELLOW}Services not running${NC}"
    fi
}

# Mode commands
cmd_mode() {
    if [ -z "$1" ]; then
        echo "Current mode: $(get_mode)"
        exit 0
    fi
    
    check_root "$@"
    
    local new_mode=$1
    if [ "$new_mode" != "minimal" ] && [ "$new_mode" != "recording" ]; then
        echo -e "${RED}Error: Mode must be 'minimal' or 'recording'${NC}"
        exit 1
    fi
    
    local current_mode=$(get_mode)
    if [ "$current_mode" = "$new_mode" ]; then
        echo "Already in $new_mode mode"
        exit 0
    fi
    
    echo "Switching from $current_mode to $new_mode mode..."
    
    # Update config
    sed -i "s/^MEDIAMTX_MODE=.*/MEDIAMTX_MODE=$new_mode/" "$CONFIG_FILE"
    
    echo -e "${GREEN}✓ Configuration updated${NC}"
    echo ""
    echo "Restart services for changes to take effect:"
    echo "  sudo dashcamctl restart"
}

# Start/Stop/Restart commands
cmd_start() {
    check_root "$@"
    echo "Starting dashcam services..."
    systemctl start "$MEDIAMTX_SERVICE"
    sleep 2
    systemctl start "$CAMERA_SERVICE"
    echo -e "${GREEN}✓ Services started${NC}"
}

cmd_stop() {
    check_root "$@"
    echo "Stopping dashcam services..."
    systemctl stop "$CAMERA_SERVICE" || true
    systemctl stop "$MEDIAMTX_SERVICE" || true
    echo -e "${GREEN}✓ Services stopped${NC}"
}

cmd_restart() {
    check_root "$@"
    echo "Restarting dashcam services..."
    systemctl stop "$CAMERA_SERVICE" || true
    systemctl restart "$MEDIAMTX_SERVICE"
    sleep 2
    systemctl start "$CAMERA_SERVICE"
    echo -e "${GREEN}✓ Services restarted${NC}"
}

# Individual service commands
cmd_start_mediamtx() {
    check_root "$@"
    systemctl start "$MEDIAMTX_SERVICE"
    echo -e "${GREEN}✓ MediaMTX started${NC}"
}

cmd_stop_mediamtx() {
    check_root "$@"
    systemctl stop "$MEDIAMTX_SERVICE"
    echo -e "${GREEN}✓ MediaMTX stopped${NC}"
}

cmd_restart_mediamtx() {
    check_root "$@"
    systemctl restart "$MEDIAMTX_SERVICE"
    echo -e "${GREEN}✓ MediaMTX restarted${NC}"
}

cmd_start_camera() {
    check_root "$@"
    systemctl start "$CAMERA_SERVICE"
    echo -e "${GREEN}✓ Camera started${NC}"
}

cmd_stop_camera() {
    check_root "$@"
    systemctl stop "$CAMERA_SERVICE"
    echo -e "${GREEN}✓ Camera stopped${NC}"
}

cmd_restart_camera() {
    check_root "$@"
    systemctl restart "$CAMERA_SERVICE"
    echo -e "${GREEN}✓ Camera restarted${NC}"
}

# Log commands
cmd_logs() {
    journalctl -u "$MEDIAMTX_SERVICE" -u "$CAMERA_SERVICE" -f
}

cmd_logs_mediamtx() {
    journalctl -u "$MEDIAMTX_SERVICE" -f
}

cmd_logs_camera() {
    journalctl -u "$CAMERA_SERVICE" -f
}

# Enable/Disable commands
cmd_enable() {
    check_root "$@"
    systemctl enable "$MEDIAMTX_SERVICE"
    systemctl enable "$CAMERA_SERVICE"
    echo -e "${GREEN}✓ Services enabled (will start on boot)${NC}"
}

cmd_disable() {
    check_root "$@"
    systemctl disable "$MEDIAMTX_SERVICE"
    systemctl disable "$CAMERA_SERVICE"
    echo -e "${GREEN}✓ Services disabled${NC}"
}

# Main command dispatcher
case "${1:-}" in
    status)
        cmd_status
        ;;
    health)
        cmd_health
        ;;
    start)
        cmd_start "$@"
        ;;
    stop)
        cmd_stop "$@"
        ;;
    restart)
        cmd_restart "$@"
        ;;
    start-mediamtx)
        cmd_start_mediamtx "$@"
        ;;
    stop-mediamtx)
        cmd_stop_mediamtx "$@"
        ;;
    restart-mediamtx)
        cmd_restart_mediamtx "$@"
        ;;
    start-camera)
        cmd_start_camera "$@"
        ;;
    stop-camera)
        cmd_stop_camera "$@"
        ;;
    restart-camera)
        cmd_restart_camera "$@"
        ;;
    mode)
        cmd_mode "$2"
        ;;
    logs)
        cmd_logs
        ;;
    logs-mediamtx)
        cmd_logs_mediamtx
        ;;
    logs-camera)
        cmd_logs_camera
        ;;
    enable)
        cmd_enable "$@"
        ;;
    disable)
        cmd_disable "$@"
        ;;
    help|--help|-h)
        show_usage
        ;;
    *)
        show_usage
        exit 1
        ;;
esac